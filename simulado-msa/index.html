<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado MSA | Issa Academy</title>
    
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LF25LGNKEJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LF25LGNKEJ');
    </script>

    <!-- Fonte e √çcones -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Music&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            /* Paleta Gamificada (Baseada na Issa Academy) */
            --brand-blue: #1a3c5a;
            --brand-gold: #c5a059;
            
            --duo-bg: #ffffff;
            --duo-surface: #f7f9fa;
            
            /* Cores de Fundo da Pergunta */
            --q-bg: #e5f6fd; 
            --q-border: #c3e3f7;
            
            /* Bot√µes e Intera√ß√£o (Juicy Colors) */
            --btn-blue: #1cb0f6; --btn-blue-shade: #1899d6;
            --btn-green: #58cc02; --btn-green-shade: #58a700;
            --btn-red: #ff4b4b;   --btn-red-shade: #ea2b2b;
            --btn-gold: #ffc800;  --btn-gold-shade: #e5b400;
            --btn-gray: #e5e5e5;  --btn-gray-shade: #cecece;
            
            --text-main: #4b4b4b;
            --text-light: #777;
            
            --radius: 16px; 
        }
        
        * { box-sizing: border-box; font-family: 'Nunito', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--duo-surface); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            min-height: 100vh; 
            display: flex; flex-direction: column; 
        }

        /* HEADER SIMPLES */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; max-width: 800px; margin: 0 auto; width: 100%;
        }
        .close-btn { font-size: 1.5rem; color: #e5e5e5; cursor: pointer; transition: color 0.2s; text-decoration: none;}
        .close-btn:hover { color: var(--text-main); }
        
        .progress-container { flex: 1; margin: 0 20px; background: #e5e5e5; height: 16px; border-radius: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--btn-gold); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 20px; position: relative; }
        .progress-highlight { position: absolute; top: 3px; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.3); border-radius: 20px; }

        /* √ÅREA DO MASCOTE (FUFU) */
        .mascot-area {
            display: flex; align-items: flex-end; gap: 15px;
            max-width: 800px; margin: 10px auto 10px; width: 100%;
            padding: 0 20px;
            min-height: 100px;
        }
        
        .fufu-avatar {
            width: 80px; height: 80px;
            font-size: 60px; /* Placeholder Emoji Size */
            display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .speech-bubble {
            background: white; border: 2px solid #e5e5e5;
            padding: 12px 18px; border-radius: 18px;
            border-top-left-radius: 2px;
            font-weight: 700; color: var(--text-main); font-size: 1rem;
            position: relative; box-shadow: 0 4px 0 #e5e5e5;
            flex: 1;
            transform-origin: left bottom;
            animation: popIn 0.3s;
        }
        .speech-bubble::before {
            content: ''; position: absolute; left: -12px; top: 0;
            border-top: 12px solid #e5e5e5; border-left: 12px solid transparent;
        }
        .speech-bubble::after {
            content: ''; position: absolute; left: -8px; top: 2px;
            border-top: 12px solid white; border-left: 12px solid transparent;
        }

        /* CONTE√öDO DO QUIZ */
        .quiz-content {
            flex: 1; max-width: 600px; margin: 0 auto; width: 100%; padding: 0 20px 100px;
            display: flex; flex-direction: column; justify-content: flex-start;
        }

        /* CART√ÉO DA PERGUNTA */
        .question-card {
            background-color: var(--q-bg);
            border: 2px solid var(--q-border);
            border-radius: var(--radius);
            padding: 25px 20px;
            margin-bottom: 25px;
            position: relative;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
        }

        .q-number-badge {
            position: absolute; top: -15px; left: -10px;
            background-color: var(--brand-blue); color: white;
            font-weight: 800; font-size: 1.1rem;
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transform: rotate(-5deg); border: 2px solid white;
        }

        h2.question-text {
            font-size: 1.25rem; color: var(--brand-blue); 
            margin: 0; line-height: 1.5;
            text-align: left; font-weight: 700;
        }

        /* OP√á√ïES */
        .options-grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
        @media (min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }

        .duo-btn {
            background: white; 
            border: 2px solid #e5e5e5; border-bottom: 4px solid #e5e5e5;
            border-radius: 16px;
            padding: 12px 16px;
            font-size: 1rem; color: var(--text-main); font-weight: 700;
            cursor: pointer; position: relative;
            transition: all 0.1s; text-align: left;
            display: flex; align-items: center; gap: 15px;
        }
        .duo-btn:active { transform: translateY(4px); border-bottom-width: 0; margin-bottom: 4px; }
        .duo-btn:hover:not(:disabled) { background: #f7f9fa; border-color: #d1d5db; border-bottom-color: #d1d5db; }

        .option-letter {
            width: 32px; height: 32px; flex-shrink: 0;
            border: 2px solid #e5e5e5; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; color: #afafaf; background: white; font-size: 0.9rem;
            transition: all 0.2s;
        }

        .duo-btn.selected { border-color: var(--btn-blue); border-bottom-color: var(--btn-blue-shade); background: #ddf4ff; color: var(--btn-blue-shade); }
        .duo-btn.selected .option-letter { background: var(--btn-blue); color: white; border-color: var(--btn-blue); }

        .duo-btn.correct { border-color: var(--btn-green); border-bottom-color: var(--btn-green-shade); background: #dfffc8; color: var(--btn-green-shade); }
        .duo-btn.correct .option-letter { background: var(--btn-green); color: white; border-color: var(--btn-green); }

        .duo-btn.wrong { border-color: var(--btn-red); border-bottom-color: var(--btn-red-shade); background: #ffdfe0; color: var(--btn-red-shade); }
        .duo-btn.wrong .option-letter { background: var(--btn-red); color: white; border-color: var(--btn-red); }

        /* CAIXA DE FEEDBACK */
        #feedback-box {
            margin-top: 20px; padding: 20px; border-radius: 16px;
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: none;
        }
        #feedback-box.correct { background: #d7ffb8; color: var(--btn-green-shade); border: 2px solid #b8f28b; }
        #feedback-box.wrong { background: #ffdfe0; color: var(--btn-red-shade); border: 2px solid #ffc1c1; }

        .feedback-header { font-weight: 800; font-size: 1.2rem; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .feedback-body { color: var(--text-main); font-size: 1rem; line-height: 1.5; }
        
        .ref-badge {
            display: inline-block; background: rgba(255,255,255,0.8);
            border: 1px solid rgba(0,0,0,0.1); padding: 6px 12px; border-radius: 12px;
            font-size: 0.85rem; font-weight: 700; color: var(--brand-blue);
            margin-top: 12px; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.05);
        }

        /* FOOTER DE A√á√ÉO */
        .action-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 2px solid #e5e5e5;
            padding: 15px 20px; display: flex; justify-content: flex-end; align-items: center;
            z-index: 100; transition: border-color 0.3s, background 0.3s;
        }
        .action-footer.correct { border-top-color: var(--btn-green); background: #f0ffe0; }
        .action-footer.wrong { border-top-color: var(--btn-red); background: #fff0f0; }

        .check-btn {
            background: var(--btn-green); color: white;
            border: none; border-bottom: 4px solid var(--btn-green-shade);
            border-radius: 12px; padding: 15px 30px;
            font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; width: 100%; transition: all 0.1s;
        }
        .check-btn:active { transform: translateY(4px); border-bottom-width: 0; }
        .check-btn.disabled { background: #e5e5e5; color: #afafaf; border-bottom-color: #cecece; pointer-events: none; }
        .check-btn.continue { background: var(--btn-blue); border-bottom-color: var(--btn-blue-shade); }
        .check-btn.continue-error { background: var(--btn-red); border-bottom-color: var(--btn-red-shade); }

        @media (min-width: 600px) { .check-btn { width: auto; min-width: 150px; } }

        /* TELA DE RESULTADO (UPGRADE) */
        .result-stats-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-bottom: 20px;
        }
        .stat-box {
            background: #f7f9fa; border: 2px solid #e5e5e5; border-radius: 16px; padding: 15px;
            text-align: center;
        }
        .stat-label { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; font-weight: 700; display: block; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--brand-blue); display: block; }

        .review-section {
            width: 100%; text-align: left; margin-top: 20px;
            max-height: 300px; overflow-y: auto;
            border-top: 2px solid #e5e5e5; padding-top: 20px;
        }
        .review-item {
            background: #fff5f5; border-left: 4px solid var(--btn-red);
            padding: 12px; border-radius: 8px; margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .review-q { font-weight: 700; color: var(--text-main); margin-bottom: 5px; }
        .review-a { color: var(--btn-green-shade); font-weight: 600; }
        .review-ref { font-size: 0.75rem; color: #888; margin-top: 4px; display: block; }

        /* TELA MENU E SELE√á√ÉO DE FASES */
        #menu-screen { text-align: center; padding-top: 30px; max-width: 600px; margin: 0 auto; padding-bottom: 40px;}
        
        .period-grid {
            display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;
        }
        @media (min-width: 480px) { .period-grid { grid-template-columns: 1fr 1fr; } }

        .period-card {
            background: white; border: 2px solid #e5e5e5; border-bottom: 4px solid #e5e5e5;
            border-radius: 16px; padding: 20px; text-align: left;
            transition: transform 0.1s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 140px; cursor: pointer;
        }
        .period-card:active { transform: translateY(4px); border-bottom-width: 2px; }
        
        /* Estado Ativo (Per√≠odo 1) */
        .period-card.active { border-color: var(--btn-blue); border-bottom-color: var(--btn-blue-shade); }
        .period-card.active .p-icon { color: var(--btn-blue); }
        
        /* Estado Bloqueado */
        .period-card.locked { 
            background: #f7f9fa; border-color: #e5e5e5; cursor: not-allowed; opacity: 0.7; 
            pointer-events: none;
        }
        .period-card.locked .p-icon { color: #ccc; }

        .p-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .p-title { font-weight: 800; font-size: 1.1rem; color: var(--text-main); margin: 0; }
        .p-subtitle { font-size: 0.85rem; color: var(--text-light); margin: 0; }
        .p-icon { font-size: 1.8rem; }

        .start-btn-big {
            background: var(--btn-green); color: white; width: 100%;
            border: none; border-bottom: 4px solid var(--btn-green-shade);
            border-radius: 16px; padding: 18px; font-size: 1.2rem; font-weight: 800;
            text-transform: uppercase; margin-top: 30px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(88, 204, 2, 0.3);
        }
        .start-btn-big:active { transform: translateY(4px); border-bottom: 0; box-shadow: none; }

        .hidden { display: none !important; }
        .time-sig { background: #eee; padding: 2px 5px; border-radius: 4px; display: inline-block; vertical-align: middle; line-height: 0.9; font-family: 'Noto Music', serif; text-align: center; }
        .time-sig span { display: block; font-size: 0.8em; }

        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { 0% { transform: translateY(10px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- MENU INICIAL (SELE√á√ÉO DE FASES) -->
    <div id="menu-screen">
        <div class="mascot-area" style="justify-content: center; margin-bottom: 0;">
            <div class="fufu-avatar" style="font-size: 80px;">üò∫</div>
        </div>
        <h1 style="color: var(--brand-blue); margin-bottom: 5px;">Simulado MSA</h1>
        
        <p style="color: var(--text-light); margin-bottom: 25px;">Selecione o conte√∫do:</p>
        
        <div class="period-grid">
            <!-- Per√≠odo 1 (Ativo) -->
            <div class="period-card active" onclick="selectPeriod(1)">
                <div class="p-header">
                    <div>
                        <h3 class="p-title">Per√≠odo 1</h3>
                        <p class="p-subtitle">Fases 1, 2 e 3</p>
                    </div>
                    <i class="fas fa-book-open p-icon"></i>
                </div>
                <div style="background: var(--btn-blue); color: white; font-size: 0.7rem; padding: 4px 8px; border-radius: 10px; width: fit-content; font-weight: 800;">SELECIONADO</div>
            </div>

            <!-- Per√≠odo 2 (Bloqueado) -->
            <div class="period-card locked">
                <div class="p-header">
                    <div>
                        <h3 class="p-title">Per√≠odo 2</h3>
                        <p class="p-subtitle">Em Breve</p>
                    </div>
                    <i class="fas fa-lock p-icon"></i>
                </div>
            </div>

            <!-- Per√≠odo 3 (Bloqueado) -->
            <div class="period-card locked">
                <div class="p-header">
                    <div>
                        <h3 class="p-title">Per√≠odo 3</h3>
                        <p class="p-subtitle">Em Breve</p>
                    </div>
                    <i class="fas fa-lock p-icon"></i>
                </div>
            </div>

            <!-- Per√≠odo 4 (Bloqueado) -->
            <div class="period-card locked">
                <div class="p-header">
                    <div>
                        <h3 class="p-title">Per√≠odo 4</h3>
                        <p class="p-subtitle">Em Breve</p>
                    </div>
                    <i class="fas fa-lock p-icon"></i>
                </div>
            </div>
        </div>

        <button class="start-btn-big" onclick="prepareAndStart()">COME√áAR SIMULADO</button>
        <a href="../index.html" style="display: block; margin-top: 20px; color: var(--text-light); text-decoration: none; font-weight: 700;">VOLTAR PARA ACADEMY</a>
    </div>

    <!-- TELA DO QUIZ -->
    <div id="quiz-screen" class="hidden">
        
        <div class="top-bar">
            <!-- Bot√£o de Sair com Confirma√ß√£o -->
            <a href="javascript:void(0)" onclick="confirmExit()" class="close-btn"><i class="fas fa-times"></i></a>
            <div class="progress-container"><div class="progress-fill" id="progress-bar"><div class="progress-highlight"></div></div></div>
            <div style="color: var(--btn-red); font-weight: 800;"><i class="fas fa-heart"></i> ‚àû</div>
        </div>

        <div class="mascot-area">
            <div id="fufu-img" class="fufu-avatar">üê±</div>
            <div id="fufu-speech" class="speech-bubble">Vamos aprender um pouquinho mais hoje?</div>
        </div>

        <div class="quiz-content">
            <!-- PERGUNTA COM FUNDO E N√öMERO -->
            <div class="question-card">
                <div id="q-number" class="q-number-badge">1</div>
                <h2 id="q-text" class="question-text">Carregando pergunta...</h2>
            </div>

            <div id="options-container" class="options-grid"></div>
            
            <!-- CAIXA DE FEEDBACK -->
            <div id="feedback-box">
                <div class="feedback-header" id="feedback-title"></div>
                <div class="feedback-body" id="feedback-content"></div>
                <div id="feedback-ref-container"></div>
            </div>
        </div>

        <!-- FOOTER DE A√á√ÉO -->
        <div id="footer-area" class="action-footer">
            <button id="check-btn" class="check-btn disabled" onclick="checkOrNext()">VERIFICAR</button>
        </div>

    </div>

    <!-- TELA DE RESULTADO FINAL (ATUALIZADA) -->
    <div id="result-screen" class="hidden" style="text-align: center; padding: 40px 20px;">
        <div id="fufu-result-img" class="fufu-avatar" style="font-size: 120px; margin: 0 auto 20px;">üò∫</div>
        <h1 id="result-title" style="color: var(--brand-blue); margin-bottom: 5px;">Treino Conclu√≠do!</h1>
        <p id="result-msg" style="color: var(--text-light); margin-bottom: 20px;">Veja como voc√™ se saiu</p>
        
        <div class="big-card" style="background: white; border-radius: 20px; border: 2px solid #e5e5e5; padding: 30px; margin: 20px auto; max-width: 400px; box-shadow: 0 10px 0 #e5e5e5;">
            <div class="result-stats-container">
                <div class="stat-box">
                    <span class="stat-label">Precis√£o</span>
                    <span class="stat-value" id="final-percent" style="color: var(--btn-green);">0%</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Tempo</span>
                    <span class="stat-value" id="final-time" style="color: var(--btn-gold-shade);">00:00</span>
                </div>
            </div>

            <!-- √ÅREA DE REVIS√ÉO (S√≥ aparece se houver erros) -->
            <div id="review-container" class="hidden">
                <h4 style="text-align: left; color: var(--btn-red); margin-bottom: 10px;"> <i class="fas fa-exclamation-circle"></i> O que precisa melhorar:</h4>
                <div id="review-list" class="review-section"></div>
            </div>

            <button class="start-btn-big" onclick="location.reload()">NOVO SIMULADO</button>
            <a href="../index.html" style="display: block; margin-top: 20px; color: var(--text-light); text-decoration: none; font-weight: 700;">VOLTAR PARA ACADEMY</a>
        </div>
    </div>

    <script>
        // === CONFIGURA√á√ÉO DO FUFU AMOROSO (v1.5) ===
        const FUFU_STATES = {
            NEUTRAL: { type: 'emoji', content: 'üê±' }, 
            HAPPY:   { type: 'emoji', content: 'üò∫' },
            SAD:     { type: 'emoji', content: 'üòø' }, // Gato com compaix√£o
            JUDGE:   { type: 'emoji', content: 'üê±' } // Gato neutro atento
        };

        const FUFU_PHRASES = {
            START: [
                "Vamos aprender um pouquinho mais hoje?", 
                "Estou aqui do seu lado. Vamos estudar com alegria!", 
                "Que bom te ver aqui, m√∫sico! O MSA nos espera.", 
                "Prepare o cora√ß√£o e a mente. Vamos l√°?"
            ],
            CORRECT: [
                "Que maravilha! Voc√™ est√° indo muito bem.", 
                "Miau! Que som agrad√°vel de acerto!", 
                "Isso mesmo! Seu esfor√ßo est√° dando frutos.", 
                "Gl√≥ria! Mais um passo na sua jornada."
            ],
            WRONG: [
                "N√£o desanime! √â errando que a gente aprende.", 
                "Calma, respire. Vamos rever isso juntos?", 
                "Ainda n√£o. Mas na pr√≥xima voc√™ acerta!", 
                "N√£o fique triste. O estudo exige paci√™ncia mesmo."
            ]
        };

        window.bancoQuestoes = []; 
        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let selectedOption = null; 
        let currentQuestionData = null;
        let isAnswerChecked = false;
        
        // VARI√ÅVEIS PARA FEEDBACK RICO
        let quizStartTime;
        let wrongAnswers = [];

        // FUN√á√ÉO DE FULL SCREEN
        function enterFullScreen() {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen().catch(err => console.log(err));
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen(); // Safari
            else if (el.msRequestFullscreen) el.msRequestFullscreen(); // IE11
        }

        function exitFullScreen() {
            if (document.exitFullscreen) document.exitFullscreen().catch(err => console.log(err));
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }

        function confirmExit() {
            if (confirm("Tem certeza? Se sair agora, perder√° o progresso do simulado.")) {
                exitFullScreen();
                location.reload();
            }
        }

        function setFufu(state, text) {
            const imgEl = document.getElementById('fufu-img');
            const speechEl = document.getElementById('fufu-speech');
            
            if(state.type === 'emoji') {
                imgEl.innerHTML = state.content;
                imgEl.removeAttribute('src');
            } else {
                imgEl.innerHTML = '';
                imgEl.src = state.content;
            }

            imgEl.style.transform = 'scale(0.8)';
            setTimeout(() => imgEl.style.transform = 'scale(1)', 150);

            if(text) speechEl.innerText = text;
        }

        function formatMusicText(text) {
            if(!text) return "";
            return text.replace(/(\d{1,2})\/(\d{1,2})/g, function(match, num, den) {
                return `<span class="time-sig"><span>${num}</span><span>${den}</span></span>`;
            });
        }

        const periodMap = { 1: ['q_f01.js', 'q_f02.js', 'q_f03.js'] };

        // Fun√ß√£o placeholder para sele√ß√£o de per√≠odo (futuramente carregar√° dinamicamente)
        function selectPeriod(p) {
            if(p !== 1) return; // S√≥ permite 1 por enquanto
            // L√≥gica visual j√° est√° est√°tica no HTML, futuramente aqui mudaria a classe active
        }

        async function loadScripts(scripts) {
            const promises = scripts.map(src => new Promise((resolve) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = resolve;
                s.onerror = () => { console.warn('Falha: ' + src); resolve(); };
                document.body.appendChild(s);
            }));
            return Promise.all(promises);
        }

        async function prepareAndStart() {
            // Tenta entrar em Full Screen
            enterFullScreen();

            const btn = document.querySelector('.start-btn-big');
            const originalText = btn.innerText;
            btn.innerText = "Carregando...";
            btn.disabled = true;

            await loadScripts(periodMap[1]);
            
            if (!window.bancoQuestoes || window.bancoQuestoes.length === 0) {
                alert("Erro ao carregar quest√µes. Verifique se os arquivos est√£o na pasta.");
                btn.innerText = originalText;
                btn.disabled = false;
                return;
            }
            
            // CONFIGURA√á√ÉO DE 20 PERGUNTAS (ESCALA AUMENTADA)
            currentQuestions = window.bancoQuestoes
                .filter(q => q.ativo !== false)
                .sort(() => 0.5 - Math.random())
                .slice(0, 20); // Agora pega 20
            
            currentIndex = 0;
            score = 0;
            wrongAnswers = [];
            quizStartTime = new Date(); // Inicia cron√¥metro
            
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            isAnswerChecked = false;
            selectedOption = null;
            currentQuestionData = currentQuestions[currentIndex];
            
            document.getElementById('footer-area').className = 'action-footer';
            document.getElementById('feedback-box').style.display = 'none';
            document.getElementById('feedback-box').className = ''; 
            
            const btn = document.getElementById('check-btn');
            btn.innerText = "VERIFICAR";
            btn.className = "check-btn disabled";
            btn.onclick = checkAnswer;

            const pct = (currentIndex / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = pct + '%';

            const randomPhrase = FUFU_PHRASES.START[Math.floor(Math.random() * FUFU_PHRASES.START.length)];
            setFufu(FUFU_STATES.NEUTRAL, randomPhrase);

            // ATUALIZA N√öMERO DA QUEST√ÉO E TEXTO
            document.getElementById('q-number').innerText = currentIndex + 1;
            document.getElementById('q-text').innerHTML = formatMusicText(currentQuestionData.pergunta);
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            const opts = [...currentQuestionData.opcoes].sort(() => 0.5 - Math.random());
            currentQuestionData.shuffledOpts = opts; 

            const letters = ['A', 'B', 'C', 'D', 'E'];

            opts.forEach((opt, idx) => {
                const btnEl = document.createElement('button');
                btnEl.className = 'duo-btn';
                const letter = letters[idx] || '?';
                btnEl.innerHTML = `<span class="option-letter">${letter}</span><span>${formatMusicText(opt.texto)}</span>`;
                btnEl.onclick = () => selectOption(btnEl, opt);
                container.appendChild(btnEl);
            });
            
            window.scrollTo(0, 0);
        }

        function selectOption(btnEl, optData) {
            if (isAnswerChecked) return;

            document.querySelectorAll('.duo-btn').forEach(b => b.classList.remove('selected'));
            
            btnEl.classList.add('selected');
            selectedOption = { el: btnEl, data: optData };
            
            const checkBtn = document.getElementById('check-btn');
            checkBtn.classList.remove('disabled');
        }

        function checkAnswer() {
            if (!selectedOption || isAnswerChecked) return;
            isAnswerChecked = true;

            const isCorrect = selectedOption.data.correta === true;
            const footer = document.getElementById('footer-area');
            const checkBtn = document.getElementById('check-btn');
            
            const feedbackBox = document.getElementById('feedback-box');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackContent = document.getElementById('feedback-content');
            const feedbackRef = document.getElementById('feedback-ref-container');

            let refBadgeHTML = "";
            if(currentQuestionData.referencia) {
                const ref = currentQuestionData.referencia;
                const itemText = ref.item ? ` ‚Ä¢ ${ref.item}` : "";
                const refText = `üìñ ${ref.livro} ‚Ä¢ Fase ${ref.fase} ‚Ä¢ P√°g. ${ref.pagina}${itemText}`;
                refBadgeHTML = `<div class="ref-badge">${refText}</div>`;
            }

            if (isCorrect) {
                score++;
                selectedOption.el.classList.add('correct');
                footer.classList.add('correct');
                
                feedbackBox.className = 'correct';
                feedbackBox.style.display = 'block';
                feedbackTitle.innerHTML = '<i class="fas fa-check-circle"></i> Correto!';
                feedbackContent.innerHTML = formatMusicText(selectedOption.data.feedback || "Resposta exata!");
                feedbackRef.innerHTML = refBadgeHTML;

                const phrase = FUFU_PHRASES.CORRECT[Math.floor(Math.random() * FUFU_PHRASES.CORRECT.length)];
                setFufu(FUFU_STATES.HAPPY, phrase);
                
                checkBtn.className = "check-btn continue";
            } else {
                selectedOption.el.classList.add('wrong');
                
                // Salva o erro para o relat√≥rio final
                const correctOpt = currentQuestionData.opcoes.find(o => o.correta);
                wrongAnswers.push({
                    question: currentQuestionData.pergunta,
                    correctAnswer: correctOpt.texto,
                    ref: refBadgeHTML
                });

                document.querySelectorAll('.duo-btn').forEach((b, idx) => {
                    if(currentQuestionData.shuffledOpts[idx].correta) {
                        b.classList.add('correct'); 
                    }
                });
                
                footer.classList.add('wrong'); 
                feedbackBox.className = 'wrong';
                feedbackBox.style.display = 'block';
                feedbackTitle.innerHTML = '<i class="fas fa-times-circle"></i> Incorreto...';
                
                const wrongExplanation = selectedOption.data.feedback ? 
                    `<div style="margin-bottom:10px; font-style:italic;">"${formatMusicText(selectedOption.data.feedback)}"</div>` : "";
                
                feedbackContent.innerHTML = `
                    ${wrongExplanation}
                    <div style="margin-top:10px; border-top:1px solid rgba(0,0,0,0.1); padding-top:10px;">
                        <strong>Solu√ß√£o:</strong> ${formatMusicText(correctOpt.texto)}
                    </div>
                `;
                feedbackRef.innerHTML = refBadgeHTML;

                const phrase = FUFU_PHRASES.WRONG[Math.floor(Math.random() * FUFU_PHRASES.WRONG.length)];
                setFufu(FUFU_STATES.SAD, phrase);
                
                checkBtn.className = "check-btn continue-error";
            }

            checkBtn.innerText = "CONTINUAR";
            checkBtn.onclick = nextQuestion;
            
            setTimeout(() => {
                feedbackBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuestions.length) {
                renderQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            // C√ÅLCULO DE TEMPO
            const timeSpent = Math.floor((new Date() - quizStartTime) / 1000);
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('final-time').innerText = timeString;

            // C√ÅLCULO DE PRECIS√ÉO
            const percentage = Math.round((score / currentQuestions.length) * 100);
            document.getElementById('final-percent').innerText = percentage + "%";

            // FEEDBACK DO FUFU (Misericordioso)
            const fufuImg = document.getElementById('fufu-result-img');
            const resultMsg = document.getElementById('result-msg');
            
            if (percentage === 100) {
                fufuImg.innerText = 'üòª';
                resultMsg.innerText = "Perfeito! Voc√™ √© um virtuoso!";
            } else if (percentage >= 80) {
                fufuImg.innerText = 'üò∫';
                resultMsg.innerText = "Muito bom! Quase l√°.";
            } else if (percentage >= 50) {
                fufuImg.innerText = 'üò∏';
                resultMsg.innerText = "Bom esfor√ßo! Continue estudando que vai dar certo.";
            } else {
                fufuImg.innerText = 'üòø';
                resultMsg.innerText = "O in√≠cio √© trabalhoso mesmo. N√£o desista!";
            }

            // LISTA DE REVIS√ÉO (SE HOUVER ERROS)
            const reviewContainer = document.getElementById('review-container');
            const reviewList = document.getElementById('review-list');
            
            if (wrongAnswers.length > 0) {
                reviewContainer.classList.remove('hidden');
                reviewList.innerHTML = wrongAnswers.map(item => `
                    <div class="review-item">
                        <div class="review-q">${formatMusicText(item.question)}</div>
                        <div class="review-a"><i class="fas fa-check"></i> ${formatMusicText(item.correctAnswer)}</div>
                        <div class="review-ref">${item.ref}</div>
                    </div>
                `).join('');
            } else {
                reviewContainer.classList.add('hidden');
            }
        }
    </script>
</body>
</html>